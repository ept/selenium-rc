<project name="selenium-rc-clients" default="dist" xmlns:maven="urn:maven-artifact-ant">

    <property name="version" value="0.7.2"/>
    <condition property="website.root" value="${ant.file.selenium-rc-clients}/../../website">
        <available file="${ant.file.selenium}/../../website"/>
    </condition>

	<target name="all" depends="test, dist" />

    <target name="clean" depends="clean-dotnet, clean-python, clean-ruby, clean-perl">
        <delete dir="dist-image"/>
        <delete dir="dist"/>
        <delete>
        	<fileset dir="." includes="iedoc.xml" />
        </delete>
    </target>

    <target name="dist" depends="dist-java, dist-dotnet, dist-ruby, dist-python, dist-perl">
    	<property name="src.release" value="selenium-remote-control-${version}"/>
    	<zip zipfile="dist/${src.release}.zip">
    		<zipfileset dir="dist-image" prefix="${src.release}" />
    	</zip>
    </target>

    <target name="dist-dirs">
        <mkdir dir="dist-image"/>
        <mkdir dir="dist"/>
    </target>

    <target name="dist-ruby" depends="dist-dirs">
        <copy todir="dist-image/ruby">
            <fileset dir="ruby">
                <include name="*.rb"/>
                <include name="doc/**" />
            </fileset>
        </copy>

        <property name="ruby.release" value="selenium-ruby-client-driver-${version}"/>
        <zip zipfile="dist/${ruby.release}.zip">
            <zipfileset dir="dist-image/ruby" prefix="${ruby.release}"/>
        </zip>
    </target>

	<target name="dist-perl" depends="dist-dirs">
        <copy todir="dist-image/perl">
            <fileset dir="perl">
                <include name="*.pl"/>
                <exclude name="mypod2html.pl" />
                <include name="WWW/**"/>
                <include name="html/**" />
            </fileset>
        </copy>

        <property name="perl.release" value="selenium-perl-client-driver-${version}"/>
        <zip zipfile="dist/${perl.release}.zip">
            <zipfileset dir="dist-image/perl" prefix="${perl.release}"/>
        </zip>
    </target>

	<target name="dist-python" depends="dist-dirs">
        <copy todir="dist-image/python">
            <fileset dir="python">
                <include name="*.py"/>
                <exclude name="mypydoc.py"/>
            </fileset>
        </copy>
        
        <copy todir="dist-image/python/doc">
            <fileset dir="python/html"/>
        </copy>

        <property name="python.release" value="selenium-python-client-driver-${version}"/>
        <zip zipfile="dist/${python.release}.zip">
            <zipfileset dir="dist-image/python" prefix="${python.release}"/>
        </zip>
    </target>

	<target name="maven-tasks">
		<typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant">
			<classpath>
				<pathelement location="maven-artifact-ant-2.0.2-dep.jar" />
			</classpath>
		</typedef>
	</target>
	
	<target name="custom-repo" depends="maven-tasks" if="custom.maven.repo">
		<presetdef name="mavendeps">
			<maven:dependencies>
				<localRepository location="${custom.maven.repo}" />
			</maven:dependencies>
		</presetdef>
	</target>
	
	<target name="default-repo" depends="maven-tasks" unless="custom.maven.repo">
		<presetdef name="mavendeps">
			<maven:dependencies/>
		</presetdef>
	</target>

    <target name="find-server" depends="custom-repo,default-repo" unless="${selenium-server.jar}">
		<mavendeps pathId="selenium-server.classpath">
			<!-- DGF Server bundles all of its dependencies, 
			which are marked with the scope "provided", so this should
			only give us selenium-server.jar -->
			<dependency groupId="org.openqa.selenium.server" artifactId="selenium-server" version="${version}" scope="runtime"/>
		</mavendeps>
		<pathconvert targetos="windows" property="selenium-server.jar" refid="selenium-server.classpath" />
		<condition property="build.failed">
			<contains string="${selenium-server.jar}" substring=";" />
		</condition>
		<fail if="build.failed" message="Maven gave us more than one Selenium Server jar: ${selenium-server.jar}" />
	</target>
	
	<target name="find-java-client" depends="custom-repo,default-repo">
		<mavendeps pathId="selenium-java-client-driver.classpath">
			<!-- DGF Server bundles all of its dependencies, 
			which are marked with the scope "provided", so this should
			only give us selenium-server.jar -->
			<dependency groupId="org.openqa.selenium.client-drivers" artifactId="selenium-java-client-driver" version="${version}" scope="runtime"/>
		</mavendeps>
		<pathconvert targetos="windows" property="selenium-java-client-driver.jar" refid="selenium-java-client-driver.classpath" />
		<condition property="build.failed">
			<contains string="${selenium-java-client-driver.jar}" substring=";" />
		</condition>
		<fail if="build.failed" message="Maven gave us more than one Selenium Java Client Driver jar: ${selenium-java-client-driver.jar}" />
	</target>
	
	<target name="start-server" depends="find-server">
		<!-- Configurable server default firefox location; if this doesn't work, we'll just try to run it off the path -->
		<property name="firefox.location" location="c:\program files\mozilla firefox\firefox.exe" />
		<java jar="${selenium-server.jar}" fork="true" spawn="true">
			<sysproperty key="firefoxDefaultPath" file="${firefox.location}" />
		</java>
		<echo message="Starting: ${selenium-server.jar}" />
    </target>
    
    <target name="extract-xml" depends="find-server">
    	<property name="output.path" location="${basedir}" />
    	<whichresource resource="iedoc.xml" property="iedoc.url" classpath="${selenium-server.jar}"/>
		<fail unless="iedoc.url" message="Couldn't find iedoc.xml in the classpath: ${selenium-server.jar}" />
		<!--<echo message="iedoc.url = ${iedoc.url}" />-->
		<get src="${iedoc.url}" dest="${output.path}/iedoc.xml" />
		<property name="iedoc.xml" location="${output.path}/iedoc.xml" />
    </target>
    
    <target name="stop-server">
    	<get taskname="selenium-shutdown" src="http://localhost:4444/selenium-server/driver/?cmd=shutDown" dest="result.txt" ignoreerrors="true" />
    	<echo taskname="selenium-shutdown" message="DGF Errors during shutdown are expected" />
    </target>
    
    <target name="test" depends="test-dotnet, test-ruby, test-python, test-perl"/>
    
    <target name="clean-python">
        <ant dir="python" target="clean"/>
    </target>
    
    <target name="test-python">
    	<echo message="python executable = ${python.executable}" />
        <ant dir="python" target="all"/>
    </target>
    
    <target name="clean-perl">
        <ant dir="perl" target="clean"/>
    </target>
    
    <target name="test-perl">
    	<echo message="perl executable = ${perl.executable}" />
        <ant dir="perl" target="all"/>
    </target>
    
    <target name="clean-dotnet">
        <ant dir="dotnet" target="clean"/>
    </target>
        
    <target name="test-dotnet">
        <ant dir="dotnet" target="test"/>
    </target>
        
    <target name="dist-dotnet" depends="dist-dirs">
		<ant dir="dotnet" target="dist"/>
		<copy todir="dist">
			<fileset dir="dotnet/dist" />
		</copy>
		<mkdir dir="dist-image/dotnet" />
		<copy todir="dist-image/dotnet">
			<fileset dir="dotnet/build/dist" />
		</copy>
	</target>
	
	<target name="dist-java" depends="dist-dirs, find-server, find-java-client">
		<mkdir dir="dist-image/server" />
		<mkdir dir="dist-image/server/source/src" />
		<mkdir dir="dist-image/server/doc" />
		<copy file="${selenium-server.jar}" tofile="dist-image/server/selenium-server.jar" />
		<unzip src="${selenium-server.jar}/../selenium-server-${version}-sources.jar" dest="dist-image/server/source/src" />
		<copy file="${selenium-server.jar}/../selenium-server-${version}-dep.jar" tofile="dist-image/server/source/selenium-server-dep.jar" />
		<unzip src="${selenium-server.jar}/../selenium-server-${version}-javadoc.jar" dest="dist-image/server/doc" />
		<copy file="${ant.file.selenium-rc-clients}/../../server/easymode/eclipse.project" tofile="dist-image/server/source/.project" />
		<copy file="${ant.file.selenium-rc-clients}/../../server/easymode/eclipse.classpath" tofile="dist-image/server/source/.classpath" />
		
		<mkdir dir="dist-image/java" />
		<mkdir dir="dist-image/java/source/src" />
		<mkdir dir="dist-image/java/doc" />
		<copy file="${selenium-java-client-driver.jar}" tofile="dist-image/java/selenium-java-client-driver.jar" />
		<copy file="${selenium-java-client-driver.jar}/../selenium-java-client-driver-${version}-tests.jar"
			tofile="dist-image/java/selenium-java-client-driver-tests.jar" />
		<unzip src="${selenium-java-client-driver.jar}/../selenium-java-client-driver-${version}-sources.jar" dest="dist-image/java/source/src" />
		<unzip src="${selenium-java-client-driver.jar}/../selenium-java-client-driver-${version}-javadoc.jar" dest="dist-image/java/doc" />
		<copy file="java/easymode/eclipse.project" tofile="dist-image/java/source/.project" />
		<copy file="java/easymode/eclipse.classpath" tofile="dist-image/java/source/.classpath" />
	</target>
	
    <target name="test-ruby">
        <ant dir="ruby" target="all"/>
    </target>

	<target name="clean-ruby">
        <ant dir="ruby" target="clean"/>
    </target>

</project>
