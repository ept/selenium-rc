<project name="selenium">
	
    <target name="generate-sources">
        <mkdir dir="target"/>
        <xslt in="target/iedoc.xml" out="lib/selenium/client/generated_driver.rb" style="iedoc2ruby.xml"/>
    </target>

    <target name="doc">
        <condition property="rdoc.executable" value="rdoc.bat">
            <os family="windows"/>
        </condition>
        <property name="rdoc.executable" value="rdoc"/>
        <exec dir="." executable="${rdoc.executable}" failonerror="true">
            <arg value="lib/selenium.rb"/>
            <arg value="lib/selenium/command_error.rb"/>
            <arg value="lib/selenium/driver.rb"/>
            <arg value="lib/selenium/client/generated_driver.rb"/>
            <arg value="lib/selenium/selenium_helper.rb"/>
        </exec>
    </target>

    <target name="test">
        <echo>${selenium-server}</echo>
        <java jar="${selenium-server}" fork="true" spawn="true"/>
        <sleep seconds="20"/>

        <property name="ruby.executable" value="ruby"/>
        <exec executable="${ruby.executable}" resultproperty="result">
            <arg value="test/integration/all_build_tests.rb"/>
            <env key="HEADLESS_TEST_MODE" value="${headless}"/>
        </exec>

        <get taskname="selenium-shutdown" src="http://localhost:4444/selenium-server/driver/?cmd=shutDown" dest="target/shutdown-result.txt" ignoreerrors="true" />
        <sleep seconds="20"/>
        <condition property="build.failed">
            <not>
                <equals arg1="0" arg2="${result}"/>
            </not>
        </condition>
        <fail if="build.failed" message="ruby tests failed!"/>
    </target>
    
    <target name="dist" depends="generate-sources, doc">
        <property name="project.version" value="UNKNOWNVERSION" />
        <property name="ruby.release" value="selenium-ruby-client-driver-${project.version}"/>
        <zip zipfile="target/${ruby.release}.zip">
            <zipfileset dir="." prefix="${ruby.release}">
                <include name="*.rb" />
                <include name="doc/**" />
            </zipfileset>
        </zip>
        <zip zipfile="target/${ruby.release}-doc.zip">
            <zipfileset dir="doc" prefix="ruby" />
        </zip>
    </target>
</project>
