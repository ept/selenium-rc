<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<!--
Copyright 2004 ThoughtWorks, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<html>
  <head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>JsUnit Utility Tests</title>
    <link rel="stylesheet" type="text/css" href="/jsunit/css/jsUnitStyle.css">
<script language="JavaScript" type="text/javascript" src="/jsunit/app/jsUnitCore.js"></script>
<script language="JavaScript" type="text/javascript" src="/jsmock/mock.js"></script>
<script language="JavaScript" type="text/javascript" src="/html-xpath/html-xpath-patched.js"></script>

<script language="JavaScript" type="text/javascript" src="/selenium-browserbot.js"></script>
<script language="JavaScript" type="text/javascript" src="/htmlutils.js"></script>
<script language="JavaScript" type="text/javascript">

function setUp() {
    // To be realistic, the elements are located in a separate IFrame.
    var iframe = document.getElementById("testIframe");
    var iWindow = iframe.contentWindow.window;

    pageBot = new PageBot(iWindow);
    element1 = iWindow.document.getElementById("id1");
    element2 = iWindow.document.getElementById("id2");
    element3 = iWindow.document.getElementById("id3");
    element4 = iWindow.document.getElementById("document.links[0]");
}

//
// Tests for PageBot.findIdentifiedElement()
//
function testFindIdentifiedElementReturnsNullIfElementNotPresent() {
    assertNull(pageBot.findIdentifiedElement('noSuchElement'));
}

function testFindIdentifiedElementReturnsHtmlElementWithMatchingId() {
    assertEquals(element3, pageBot.findIdentifiedElement('id3'));
}

function testFindIdentifiedElementReturnsFirstElementWithMatchingName() {
    assertEquals(element2, pageBot.findIdentifiedElement('name1'));
}

//
// Tests for PageBot.findElementByDomTraversal
//
function testFindElementByDomTraversal() {
    assertEquals(element2,
                 pageBot.findElementByDomTraversal("document.links[1]"))
}

function testFindElementByDomTraversalReturnsNullForNoMatchingElement() {
    assertNull(pageBot.findElementByDomTraversal("document.links[3]"))
}

function testFindElementByDomTraversalFailsWithInvalidDomString() {
    try {
        pageBot.findElementByDomTraversal("document.foo.bar");
        fail("Should have thrown exception");
    }
    catch (e) {
        // Expected
    }
}

//
// Tests for PageBot.findElementByXPath
//
function testFindElementByXPathWithTagNameOnly() {
    assertEquals(element4,
                 pageBot.findElementByXPath("//p"));
}

function testFindElementByXPathWithAttributeOnly() {
    assertEquals(element4,
                 pageBot.findElementByXPath("//*[@class='pstyle']"));
}

function testFindElementByXPathWithTagNameAndAttribute() {
    assertEquals(element4,
                 pageBot.findElementByXPath("//p[@name='name1']"));
}

function testFindElementByXPathReturnsFirstMatchingElement() {
    assertEquals(element2,
                 pageBot.findElementByXPath("//*[@name='name1']"));
}

//
// Tests for PageBot.findElement()
//
function testFindElementCallsEachLocatorInSequenceAndThrowsErrorIfNoneReturnElement() {
    var calls = new Array();
    var locators = [function(locator) {calls.push("1 " + locator)},
                    function(locator) {calls.push("2 " + locator)},
                    function(locator) {calls.push("3 " + locator)}];
    pageBot.locators = locators;

    var element = null;
    var failureMessage = null;
    try {
        element = pageBot.findElement("foo");
    } catch (e) {
        failureMessage = e.message;
    }

    assertNull(element);
    assertEquals("Element foo not found", failureMessage);
    assertEquals("1 foo,2 foo,3 foo", calls.join());
}

function testFindElementReturnsTheFirstElementReturnedByALocatorFunction() {
    var calls = new Array();
    var locators = [function(locator) {calls.push("1 " + locator)},
                    function(locator) {calls.push("2 " + locator); return "bar";},
                    function(locator) {calls.push("3 " + locator)}];
    pageBot.locators = locators;

    var element = null;
    var failureMessage = null;
    try {
        element = pageBot.findElement("foo");
    } catch (e) {
        failureMessage = e.message;
    }

    assertEquals("bar", element);
    assertNull(failureMessage);
    assertEquals("1 foo,2 foo", calls.join());
}

function testFindElementReturnsElementWithMatchingIdentifier() {
    assertEquals(element2, pageBot.findElement("id2"));
}

function testFindElementReturnsMatchingName() {
    assertEquals(element2, pageBot.findElement("name1"));
}

function testFindElementLooksForIdentifiedElementBeforeDomTraversal() {
    assertEquals(element4, pageBot.findElement("document.links[0]"));
}

function testUnknownElementWithoutDomTraversal() {
    try {
        pageBot.findElement("unknownElement");
        fail("Should have failed for element not found");
    }
    catch (e) {
        // expected
    }
}

function testUnknownElementWithDomTraversal() {
    try {
        pageBot.findElement("document.foo");
        fail("Should have failed for element not found");
    }
    catch (e) {
        // expected
    }
}

function testFindElementHandlesDomTraversal() {
    assertEquals(element3, pageBot.findElement("document.links[2]"));
}
</script>
  </head>

  <body>
    <iframe id="testIframe" src="./pagebot-locator-tests-include.html"/>
  </body>
</html>
